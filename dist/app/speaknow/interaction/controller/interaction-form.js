define(["connecta.speaknow","speaknow/interaction/service/interaction-service","speaknow/action/service/action-service","speaknow/action/controller/action-modal","portal/layout/service/notify"],function(speaknow){return speaknow.lazy.controller("InteractionFormController",["$scope","InteractionService","ActionService","$location","$routeParams","$translate","$modal","speaknowResources","notify",function($scope,InteractionService,ActionService,$location,$routeParams,$translate,$modal,speaknowResources,notify){$scope.imageFile=[];$scope.removeImage=false;$scope.imageUrl=[];$scope.interaction={icon:"dump"};$scope.baseUrl=speaknowResources.base;$translate("INTERACTION.DROP_FILE_HERE").then(function(text){$scope.interactionImg=text});$scope.interactionTypes=[];ActionService.getActionTypes().then(function(response){$scope.interactionTypes=response.data;$scope.interaction.type=$scope.interactionTypes[0]});$scope.isEditing=false;if($routeParams.id){$scope.isEditing=true;InteractionService.get($routeParams.id).success(function(data){$scope.interaction=data;if($scope.interaction.image){$scope.interactionImage=$scope.baseUrl+$scope.interaction.image;$scope.imageUrl.push({image:$scope.interactionImage,extension:"PNG"})}})}$scope.icons=[];ActionService.getIcons().success(function(data){$scope.icons=data.icons});$scope.openIconModal=function(){var modalIcon=$modal.open({templateUrl:"app/speaknow/action/template/modal.html",controller:"ActionFormModalController",windowClass:"connecta-modal",resolve:{items:function(){return $scope.icons},selected:function(){return $scope.interaction.icon}}});modalIcon.result.then(function(selectedItem){$scope.interaction.icon=selectedItem})};$scope.onFileSelected=function(files){if(files&&files.length){var file=files[0];$scope.fileImage=file;$scope.imgName=file.name;var reader=new FileReader;reader.onload=function(e){if($scope.validateImage(e)){$scope.interactionImage=e.target.result;$scope.$apply()}else{$scope.interactionImage=null}};reader.readAsDataURL(files[0])}else{notify.warning("INTERACTION.INVALID_DOCUMENT")}};var validateForm=function(){$scope.interaction_form.$submitted=true;if($scope.interactionImage===null){$scope.imageInvalid=true;return false}else{$scope.imageInvalid=false}return $scope.interaction_form.$valid};$scope.nextStep=function(){if(!validateForm()){return}$scope.interaction.image=$scope.fileImage;$scope.interaction.removeImage=$scope.removeImage;ActionService.setInteraction($scope.interaction);$location.path("speaknow/action/new")};$scope.save=function(){InteractionService.save($scope.interaction,$scope.fileImage,$scope.removeImage).then(function(){notify.success("INTERACTION.SUCCESS");$location.path("speaknow/interaction")},function(response){if(response.status===403){notify.success("INTERACTION.FORBIDDEN")}})};$scope.validateImage=function(image){var isValid=true;if(image.size/1e6>1){notify.warning("COMPANY.VALIDATION.IMAGESIZE");$scope.clearImage();isValid=false}else{var img=angular.element("<img>")[0];img.src=$scope.interactionImage;if(img.height>=img.width){notify.warning("COMPANY.VALIDATION.IMAGEFORM");$scope.clearImage();isValid=false}}return isValid};$scope.dropImageCallback=function(){if($scope.imageFile.length<1){$scope.removeImage=true}else{$scope.fileImage=$scope.imageFile[0];$scope.interactionImage=$scope.imageUrl[0].image;$scope.validateImage($scope.imageFile[0]);$scope.removeImage=false}};$scope.clearImage=function(){$scope.removeImage=true;$scope.interactionImage=null;$scope.fileImage=null;$scope.imageFile=[];$scope.imageUrl=[]}}])});