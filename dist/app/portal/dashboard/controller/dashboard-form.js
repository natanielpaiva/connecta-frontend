define(["connecta.portal","portal/dashboard/service/dashboard-service","portal/dashboard/directive/viewer","presenter/viewer/directive/analysis-viewer","presenter/viewer/directive/twitter-timeline-viewer","presenter/viewer/directive/singlesource-viewer","presenter/viewer/directive/singlesource-group-viewer","presenter/viewer/directive/combined-viewer","maps/layer-viewer/directive/map-viewer","portal/layout/filter/data-uri"],function(portal){return portal.lazy.controller("DashboardFormController",["$scope","DashboardService","$routeParams","$location","$filter","SidebarService","applications","$modal","$http",function($scope,DashboardService,$routeParams,$location,$filter,SidebarService,applications,$modal,$http){$scope.dashboard={};$scope.dashboard.isPublic=false;var _sectionTemplate={name:$filter("translate")("DASHBOARD.NEW_SECTION"),items:[],columns:12,active:true};SidebarService.config({controller:function($scope){$scope.applications=applications;$scope.search={terms:"",results:[]};$scope.search.doSearch=function(){DashboardService.searchViewers($scope.search.terms).then(function(response){angular.forEach(response.data,function(obj){var viewerPath=applications[obj.module].host+applications[obj.module].viewerPath;obj.viewerUrl=viewerPath.replace(":id",obj.id);obj.viewer=obj.id;delete obj.id});$scope.search.results=response.data})};$scope.$watch("search.terms",function(){$scope.search.doSearch()})},src:"app/portal/dashboard/template/_dashboard-form-viewer-search.html"}).show();$scope.$on("$locationChangeStart",function(){SidebarService.hide()});if($routeParams.id){DashboardService.get($routeParams.id).then(function(response){response.data.sections.forEach(function(section){section.draggable={enabled:true};section.resizable={enabled:true}});response.data.sections[0].active=true;$scope.dashboard=response.data})}else{var section=angular.copy(_sectionTemplate);section.order=0;$scope.dashboard={sections:[section],displayMode:"VERTICAL"}}$scope.gridsterOpts={columns:12,pushing:true,floating:true,swapping:false,width:"auto",colWidth:"auto",rowHeight:"match",margins:[10,10],outerMargin:true,isMobile:false,mobileBreakPoint:600,mobileModeEnabled:true,minColumns:1,minRows:2,maxRows:100,defaultSizeX:2,defaultSizeY:1,minSizeX:1,maxSizeX:null,minSizeY:1,maxSizeY:null,resizable:{enabled:true,handles:["n","e","s","w","ne","se","sw","nw"],start:function(event,$element,widget){},resize:function(event,$element,widget){},stop:function(event,$element,widget){}},draggable:{enabled:true,handle:".my-class",start:function(event,$element,widget){},drag:function(event,$element,widget){},stop:function(event,$element,widget){}}};$scope.gridsterItemConfig={sizeX:"item.sizeX",sizeY:"item.sizeY",row:"item.row",col:"item.column"};$scope.addSection=function(){if($scope.dashboard.sections){var section=angular.copy(_sectionTemplate);section.order=$scope.dashboard.sections.length;$scope.dashboard.sections.push(section)}};$scope.renameSection=function($event,section,edit){$event.preventDefault();section.edit=edit};$scope.removeSection=function($event,section){$event.preventDefault();$scope.dashboard.sections.splice($scope.dashboard.sections.indexOf(section),1)};$scope.remove=function(item){$scope.items.splice($scope.items.indexOf(item),1)};$scope.config=function(){var $parentScope=$scope;$modal.open({animation:true,templateUrl:"app/portal/dashboard/template/_dashboard-form-config.html",controller:["$scope",function($scope){$scope.dashboard=$parentScope.dashboard;$scope.fileDropped=function($files){$scope.dashboard.backgroundImage=$files[0]};$scope.displayModes=["VERTICAL","HORIZONTAL"];$scope.animations=["FADE","SLIDE_UP","SLIDE_DOWN","SLIDE_RIGHT","SLIDE_LEFT"]}],size:"lg"})};$scope.itemConfig=function(item,section){$modal.open({animation:true,templateUrl:"app/portal/dashboard/template/_dashboard-form-item-config.html",controller:["$scope",function($scope){$scope.item=item;$scope.fileDropped=function($files){$scope.item.backgroundImage=$files[0]};$scope.displayModes=["VERTICAL","HORIZONTAL"];$scope.animations=["FADE","SLIDE_UP","SLIDE_DOWN","SLIDE_RIGHT","SLIDE_LEFT"];$scope.removeItem=function($close){section.items.splice(section.items.indexOf(item),1);$close()}}],size:"lg"})};$scope.toRGBA=function(hex,opacity){if(!hex||hex.length<7){return"transparent"}var result=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);if(!result){return"transparent"}var color={red:parseInt(result[1],16),green:parseInt(result[2],16),blue:parseInt(result[3],16)};return["rgba(",color.red,",",color.green,",",color.blue,",",opacity?opacity/100:1,")"].join("")};$scope.getImage=function(image){if(image&&angular.isString(image)){return"url("+image+")"}else if(image&&image.base64){return"url("+image.base64+")"}else{return"none"}};$scope.save=function(){DashboardService.save($scope.dashboard).then(function(response){$location.path("dashboard/"+response.data.id)})}}])});