<div class="viewer-header" ng-if="!edit">
    <h3>{{model.name}}</h3>
    <div class="controls">
        <span class="drillup icon-triangle-up" ng-click="drillUp()" ng-if="drillOrder > 0"
              title="{{'DASHBOARD.DRILL_UP'|translate}}"></span>
        <span class="drill icon-select-arrows" ng-click="options.isDrilling = !options.isDrilling"
              ng-class="{active:options.isDrilling}" title="{{'DASHBOARD.ACTIVATE_DRILL'|translate}}"
              ng-if="model.analysis.hasDrill"></span>
        <span class="filter icon-filter2" ng-click="options.filterConfigOpen = true"
              title="{{'DASHBOARD.OPEN_FILTER'|translate}}"
              ng-if="(model.analysisViewerColumns| filter:{columnType:'FILTER'}).length"
              ng-class="{
                  active:options.filterConfigOpen
                  }"></span>
<!--    Feio demais essa classe com uuid, mas se não tiver não tem como distinguir
        se o click fora é nesse visualizador dentro do dashboard ou em qualquer
        outro, se tirar, só o primeiro dropdown do dashboard abre. -->
        <div ng-init="openOptionsClass='.connecta-viewer-'+$parent.$parent.uuid+' .icon-dots-three-vertical'"
            class="other-options" ng-click="options.otherOptionsOpen = true">
            <span class="icon-dots-three-vertical"></span>
            <div class="connecta-dropdown" ng-show="options.otherOptionsOpen"
                 click-out="options.otherOptionsOpen=false"
                 click-out-exceptions="[openOptionsClass]">
                <div class="connecta-dropdown-item" ng-click="exportCsv()">
                    <span class="icon-spread-sheet"
                          title="{{'DASHBOARD.EXPORT_CSV'|translate}}"></span>
                    {{'DASHBOARD.EXPORT_CSV'|translate}}
                </div>
                <div class="connecta-dropdown-item" ng-click="model.exportImage()">
                    <span id="png" class="icon-image4"
                          title="{{'DASHBOARD.EXPORT_PNG'|translate}}"></span>
                    {{'DASHBOARD.EXPORT_PNG'|translate}}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="drill-breadcrumb" ng-if="notEmpty().length">
    <div class="drill-breadcrumb-item drill-breadcrumb-item-home">
        <span class="fa fa-home" ng-click="drillUpFromBreadCrumb(0)"></span>
    </div>
    <div class="drill-breadcrumb-item" ng-repeat="drill in notEmpty() track by $index"
         title="{{drill.label}}: {{drill.filterDrillValue}}" ng-click="drillUpFromBreadCrumb($index + 1)">
        {{drill.filterDrillValue}}
    </div>
</div>

<amchart ng-if="model.configuration.type !== 'table'" ng-model="model.configuration" return-chart="!edit"></amchart>

<div ng-if="model.configuration.type === 'table'">
    <table  class="table table-striped table-hover table-viewer table-condensed table-single-line">
        <thead>
            <tr dnd-list="model.columns" dnd-drop="transformColumnDrop(item, 'COLUMN')" class="row">
                <th class="text-center" ng-if="columnExample === '' && model.configuration.type === 'table'" translate>VIEWER.DRAG_HERE</th>
                <th dnd-draggable="n" dnd-moved="model.columns.splice($index, 1)"
                    ng-repeat="n in model.columns" class="text-center"
                    ng-if="columnExample !== '' && n.columnType === 'COLUMN'">

                    {{n.analysisColumn.label| translate}}
                    <span ng-if="edit" class="icon-close" ng-click="model.columns.splice($index, 1)"></span>
                </th>
            </tr>
        </thead>
        <tbody>
            <tr class="row" ng-repeat="example in model.configuration.data track by $index">
                <td ng-repeat="n in columnsTable track by $index" class="text-center" translate>
                    {{example[n.value]}}
                </td>
            </tr>
        </tbody>
    </table>
</div>

<!--click-out="options.filterConfigOpen=false" click-out-exceptions="['.filter']"-->
<div class="viewer-filter-config" ng-class="{'viewer-filter-active':options.filterConfigOpen}"
     ng-if="options.filterConfigOpen">
    <div class="viewer-filter-config-header">
        <span class="viewer-filter-config-title" translate>DASHBOARD.FILTER.SELECT_FILTER</span>
        <span class="icon-checkmark3" ng-click="getAnalysisResult()"
              title="{{'DASHBOARD.FILTER.APPLY'|translate}}"></span>
        <span class="icon-cancel3" ng-click="options.filterConfigOpen = false"
              title="{{'DASHBOARD.FILTER.CLOSE'|translate}}"></span>
    </div>
    <div class="viewer-filter-config-content">
        <div ng-repeat="filter in model.analysisViewerColumns| filter:{columnType:'FILTER'} | orderBy:'analysisColumn.label' track by $index">
            <div class="viewer-filter-config-label"
                 title="{{filter.analysisColumn.label}}">
                {{filter.analysisColumn.label}}
            </div>
            <div class="viewer-filter-config-type"
                 ng-class="{active:filter.active}">
                <div class="viewer-filter-config-type-button"
                     title="{{'DASHBOARD.FILTER.SELECTED_FILTER'|translate:{name: (filterOperators[filter.type].name|translate) } }}"
                     ng-click="filter.active = !filter.active">
                    <span class="{{filterOperators[filter.type].icon}}"></span>
                </div>
                <div class="viewer-filter-config-type-arrow"
                     title="{{'DASHBOARD.FILTER.TYPE'|translate}}"
                     ng-click="filter.optionsVisible = !filter.optionsVisible"
                     ng-class="{opened:filter.optionsVisible}">
                    <span class="icon-keyboard-arrow-down"></span>
                </div>
                <div class="connecta-dropdown viewer-filter-config-type-options"
                     ng-show="filter.optionsVisible" click-out="filter.optionsVisible=false"
                     click-out-exceptions="['.connecta-viewer-'+$parent.$parent.$parent.uuid+' .viewer-filter-config-type-arrow:eq('+$index+')']">
                    <div class="connecta-dropdown-item"
                         ng-repeat="operator in m2a(filterOperators)| orderBy:'order'"
                         ng-click="filter.type = operator.id; filter.optionsVisible = false"
                         ng-class="{active:filter.type == operator.id}">
                        <span class="{{operator.icon}}"></span>
                        {{operator.name| translate}}
                    </div>
                </div>
            </div>
            <div class="viewer-filter-config-value" ng-switch="filterOperators[filter.type].type">
                <input type="text" class="form-control input-sm"
                       ng-switch-when="STRING"
                       placeholder="{{'DASHBOARD.FILTER.VALUE'|translate}}"
                       ng-model="filter.value.value" />
                <div ng-switch-when="VALUE">
                    <ui-select ng-model="filter.value.value" ng-init="possibleValues(filter)">
                        <ui-select-match placeholder="{{'VIEWER.SELECT'|translate}}">{{$select.selected}}</ui-select-match>
                        <ui-select-choices repeat="a in filter.possibleValues | filter: $select.search track by a">
                            <span ng-bind-html="a | highlight: $select.search"></span>
                        </ui-select-choices>
                    </ui-select>
                </div>

                <input type="text" class="form-control input-sm"
                       ng-switch-when="NUMBER"
                       placeholder="{{'DASHBOARD.FILTER.VALUE'|translate}}"
                       ng-model="filter.value.value" />
                <div ng-switch-when="INTERVAL" class="viewer-filter-config-value-between">
                    <input type="text" class="form-control input-sm"
                           placeholder="{{'DASHBOARD.FILTER.START'|translate}}"
                           ng-model="filter.value.between.start" />
                    <input type="text" class="form-control input-sm"
                           placeholder="{{'DASHBOARD.FILTER.END'|translate}}"
                           ng-model="filter.value.between.end" />
                </div>
                <div ng-switch-when="ARRAY">
                    <ui-select ng-model="filter.value.in" ng-init="possibleValues(filter)" multiple>
                        <ui-select-match placeholder="{{'VIEWER.SELECT'|translate}}">{{$item}}</ui-select-match>
                        <ui-select-choices repeat="a in filter.possibleValues | filter: $select.search track by a">
                            <span ng-bind-html="a | highlight: $select.search"></span>
                        </ui-select-choices>
                    </ui-select>
                </div>
            </div>
        </div>
    </div>
</div>
